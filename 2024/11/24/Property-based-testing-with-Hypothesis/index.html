<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  
  <title>Property-based testing with Hypothesis | Fasih Khatib</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="I’d previously written about property-based testing in Clojure. In this blog post I’d like to talk about how we can do the same in Python using the Hypothesis library. We’ll begin with a quick recap o">
<meta property="og:type" content="article">
<meta property="og:title" content="Property-based testing with Hypothesis">
<meta property="og:url" content="http://fasihkhatib.com/2024/11/24/Property-based-testing-with-Hypothesis/index.html">
<meta property="og:site_name" content="Fasih Khatib">
<meta property="og:description" content="I’d previously written about property-based testing in Clojure. In this blog post I’d like to talk about how we can do the same in Python using the Hypothesis library. We’ll begin with a quick recap o">
<meta property="og:locale">
<meta property="article:published_time" content="2024-11-24T14:07:21.000Z">
<meta property="article:modified_time" content="2024-11-24T14:14:25.189Z">
<meta property="article:author" content="Fasih Khatib">
<meta property="article:tag" content="python">
<meta property="article:tag" content="testing">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Fasih Khatib" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Fasih Khatib</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About Me</a>
        
          <a class="main-nav-link" href="/principles">Guiding Principles</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://fasihkhatib.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Property-based-testing-with-Hypothesis" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2024/11/24/Property-based-testing-with-Hypothesis/" class="article-date">
  <time datetime="2024-11-24T14:07:21.000Z" itemprop="datePublished">2024-11-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Property-based testing with Hypothesis
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I’d <a href="/2017/11/16/unit-testing-with-specs/">previously written about property-based testing in Clojure</a>. In this blog post I’d like to talk about how we can do the same in Python using the <a target="_blank" rel="noopener" href="https://hypothesis.readthedocs.io/en/latest/quickstart.html">Hypothesis</a> library. We’ll begin with a quick recap of what property-based testing is, and then dive head-first into writing some tests.  </p>
<h2 id="What-is-property-based-testing"><a href="#What-is-property-based-testing" class="headerlink" title="What is property-based testing?"></a>What is property-based testing?</h2><p>Before we get into property-based testing, let’s talk about how we usually write tests. We provide a known input to the code under test, capture the resulting output, and write an assertion to check that it matches our expectations. This technique of writing tests is called example-based testing since we provide examples of inputs that the code has to work with.  </p>
<p>While this technique works, there are some drawbacks to it. Example-based tests take longer to write since we need to come up with examples ourselves. Also, it’s possible to miss out on corner cases.</p>
<p>In contrast, property-based testing allows us to specify the properties of the code and test that they hold true under a wide range of inputs. For example, if we have a function <code>f</code> that takes an integer and performs some computation on it, a property-based test would test it for positive integers, negative integers, very large integers, and so on. These inputs are generated for us by the testing framework and we simply need to specify what kind of inputs we’re looking for.  </p>
<p>Having briefly discussed what property-based testing is, let’s write some code.  </p>
<h2 id="Writing-property-based-tests"><a href="#Writing-property-based-tests" class="headerlink" title="Writing property-based tests"></a>Writing property-based tests</h2><h3 id="Testing-a-pure-function"><a href="#Testing-a-pure-function" class="headerlink" title="Testing a pure function"></a>Testing a pure function</h3><p>Let’s start with a function which computes the n’th Fibonacci number.   </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@functools.cache</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fibonacci</span>(<span class="params">n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Computes the nth number in the Fibonacci sequence.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fibonacci(n - <span class="number">1</span>) + fibonacci(n - <span class="number">2</span>)</span><br></pre></td></tr></table></figure>  
<p>The sequence of numbers goes 0, 1, 1, 2, 3, etc. We can see that all of these numbers are greater than or equal to zero. Let’s write a property-based test to formalize this.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hypothesis <span class="keyword">import</span> given, strategies <span class="keyword">as</span> st</span><br><span class="line"><span class="keyword">from</span> functions <span class="keyword">import</span> fibonacci</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@given(<span class="params">st.integers(<span class="params"></span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_fibonacci</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">assert</span> fibonacci(n) &gt;= <span class="number">0</span></span><br></pre></td></tr></table></figure>  
<p>In the code snippet above, we’ve wrapped our test using the <code>@given</code> decorator. This makes it a property-based test. The argument to the decorator is a search strategy. A search strategy generates random data of a given type for us. Here we’ve specified that we need integers. We can now run the test using pytest as follows.  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PYTHONPATH=. pytest .</span><br></pre></td></tr></table></figure>  
<p>The test fails with the following summary.  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FAILED test/functions/test_fibonacci.py::test_fibonacci - ExceptionGroup: Hypothesis found 2 distinct failures. (2 sub-exceptions)</span><br></pre></td></tr></table></figure>  
<p>When looking at the logs, we find that the first failure is because the maximum recursion depth is reached when the value of <code>n</code> is large. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">n = 453</span><br><span class="line">... lines omitted ...</span><br><span class="line">RecursionError: maximum recursion depth exceeded</span><br></pre></td></tr></table></figure>  
<p>The second failure is because the function returned a negative integer when the value of <code>n</code> is negative; in this case it is <code>n=-1</code>. This violates our assertion that the numbers in the Fibonacci sequence are non-negative.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+---------------- 2 ----------------</span><br><span class="line">| Traceback (most recent call last):</span><br><span class="line">|   File "/Users/fasih/Personal/pytesting/test/functions/test_fibonacci.py", line 8, in test_fibonacci</span><br><span class="line">|     assert fibonacci(n) &gt;= 0</span><br><span class="line">| AssertionError: assert -1 &gt;= 0</span><br><span class="line">|  +  where -1 = fibonacci(-1)</span><br><span class="line">| Falsifying example: test_fibonacci(</span><br><span class="line">|     n=-1,</span><br><span class="line">| )</span><br><span class="line">+------------------------------------</span><br></pre></td></tr></table></figure>  
<p>To remedy the two failures above, we’ll add an assertion at the top of the function which will ensure that the input <code>n</code> is in some specified range. The updated function is given below.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@functools.cache</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fibonacci</span>(<span class="params">n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Computes the nth number in the Fibonacci sequence.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="number">0</span> &lt;= n &lt;= <span class="number">300</span>, <span class="string">f"n must be between 0 and 300; <span class="subst">{n}</span> was passed."</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fibonacci(n - <span class="number">1</span>) + fibonacci(n - <span class="number">2</span>)</span><br></pre></td></tr></table></figure>  
<p>We’ll update our test cases to reflect this change in code. The first test case checks the function when <code>n</code> is between 0 and 300.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@given(<span class="params">st.integers(<span class="params">min_value=<span class="number">0</span>, max_value=<span class="number">300</span></span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_fibonacci</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">assert</span> fibonacci(n) &gt;= <span class="number">0</span></span><br></pre></td></tr></table></figure>  
<p>The second case checks when <code>n</code> is large. In this case we check that the function raises an <code>AssertionError</code>. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@given(<span class="params">st.integers(<span class="params">min_value=<span class="number">5000</span></span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_fibonacci_large_n</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">with</span> pytest.raises(AssertionError):</span><br><span class="line">        fibonacci(n)</span><br></pre></td></tr></table></figure>  
<p>Finally, we’ll check the function with negative values of <code>n</code>. Similar to the previous test case, we’ll check that the function raises an <code>AssertionError</code>.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@given(<span class="params">st.integers(<span class="params">min_value=-<span class="number">2</span>, max_value=-<span class="number">1</span></span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_fibonacci_negative</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">with</span> pytest.raises(AssertionError):</span><br><span class="line">        fibonacci(n)</span><br></pre></td></tr></table></figure>  
<h3 id="Testing-persistent-data"><a href="#Testing-persistent-data" class="headerlink" title="Testing persistent data"></a>Testing persistent data</h3><p>We’ll now use Hypothesis to generate data that we’d like to persist in the database. The snippet below shows a <code>Person</code> model with fields to store name and date of birth. The <code>age</code> property returns the current age of the person in years, and the <code>MAX_AGE</code> variable indicates that the maximum age we’d like to allow in the system is 120 years. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(peewee.Model):</span><br><span class="line"></span><br><span class="line">    MAX_AGE = <span class="number">120</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        database = db</span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = peewee.BigAutoField(primary_key=<span class="literal">True</span>, null=<span class="literal">False</span>)</span><br><span class="line">    name = peewee.CharField(null=<span class="literal">False</span>, max_length=<span class="number">120</span>)</span><br><span class="line">    dob = peewee.DateField(null=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">age</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> (datetime.date.today()).year - self.dob.year</span><br></pre></td></tr></table></figure>  
<p>We’ll add a helper function to create <code>Person</code> instances as follows.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">name: <span class="built_in">str</span>, dob: datetime.date</span>) -&gt; Person:</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Create a new person instance with the given name and date of birth.</span></span><br><span class="line"><span class="string">    :param name: Name of the person.</span></span><br><span class="line"><span class="string">    :param dob: Date of birth of the person.</span></span><br><span class="line"><span class="string">    :return: A Person instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">assert</span> name, <span class="string">f"name cannot by empty"</span></span><br><span class="line">    <span class="keyword">return</span> Person.create(name=name, dob=dob)</span><br></pre></td></tr></table></figure>  
<p>Like we did for the function which computes Fibonacci numbers, we’ll add a test case to formalize this expectation. This time we’re generating random names and dates of birth and passing them to the helper function.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@given(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">    text=st.text(<span class="params">min_size=<span class="number">1</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    dob=st.dates(<span class="params"></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_create_person</span>(<span class="params">text, dob, create_tables</span>):</span><br><span class="line">    person = pr.create(name=text, dob=dob)</span><br><span class="line">    <span class="keyword">assert</span> <span class="number">0</span> &lt;= person.age &lt;= Person.MAX_AGE</span><br></pre></td></tr></table></figure>  
<p>I’m persisting this data in a Postgres table and the <code>create_tables</code> fixture ensures that the tables are created before the test runs.   </p>
<p>Upon running the test we find that it fails for two cases. The first case is when the input string contains a NULL character <code>\x00</code>. Postgres tables do not allow strings will NULL characters in them.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ValueError: A string literal cannot contain NUL (0x00) characters.</span><br><span class="line">Falsifying example: test_create_person(</span><br><span class="line">     create_tables=None,</span><br><span class="line">     text='\x00',</span><br><span class="line">     dob=datetime.date(2000, 1, 1),  # or any other generated value</span><br><span class="line">)</span><br></pre></td></tr></table></figure>  
<p>The second case is when the date of birth is in the future. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">AssertionError: assert 0 &lt;= -1</span><br><span class="line">  +  where -1 = &lt;Person: 5375&gt;.age</span><br><span class="line"> Falsifying example: test_create_person(</span><br><span class="line">     create_tables=None,</span><br><span class="line">     text='0',  # or any other generated value</span><br><span class="line">     dob=datetime.date(2025, 1, 1),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>  
<p>To remedy the first failure, we’ll have to sanitize the <code>name</code> input string that gets stored in the table. We’ll create a helper function which removes any NULL characters from the string. This will be called before <code>name</code> gets saved in the table.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">sanitize</span>(<span class="params">s: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">return</span> s.replace(<span class="string">"\x00"</span>, <span class="string">""</span>).strip()</span><br></pre></td></tr></table></figure>  
<p>To remedy the second failure, we’ll add an assertion ensuring that the age is less than or equal to 120. The updated <code>create</code> function is shown below.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">name: <span class="built_in">str</span>, dob: datetime.date</span>) -&gt; Person:</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Create a new person instance with the given name and date of birth.</span></span><br><span class="line"><span class="string">    :param name: Name of the person.</span></span><br><span class="line"><span class="string">    :param dob: Date of birth of the person.</span></span><br><span class="line"><span class="string">    :return: A Person instance.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    name = sanitize(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> name, <span class="string">f"name cannot by empty"</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="number">0</span> &lt;= (datetime.date.today().year - dob.year) &lt;= Person.MAX_AGE</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Person.create(name=name, dob=dob)</span><br></pre></td></tr></table></figure>  
<p>We’ll update the test cases to reflect these changes. Let’s start by creating two variables that will hold the minimum and maximum dates allowed.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MIN_DATE = datetime.date.today() - datetime.timedelta(days=Person.MAX_AGE * <span class="number">365</span>)</span><br><span class="line">MAX_DATE = datetime.date.today()</span><br></pre></td></tr></table></figure>  
<p>Next, we’ll add a test to ensure that we raise an <code>AssertionError</code> when the string contains only NULL characters.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@given(<span class="params">text=st.text(<span class="params">alphabet=[<span class="string">"\x00"</span>]</span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_create_person_null_text</span>(<span class="params">text, create_tables</span>):</span><br><span class="line">    <span class="keyword">with</span> pytest.raises(AssertionError):</span><br><span class="line">        pr.create(name=text, dob=MIN_DATE)</span><br></pre></td></tr></table></figure>
<p>Next, we’ll add a test to ensure that dates cannot be in the future.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@given(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">    text=st.text(<span class="params">min_size=<span class="number">1</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    dob=st.dates(<span class="params">min_value=MAX_DATE + datetime.timedelta(<span class="params">days=<span class="number">365</span></span>)</span>),</span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_create_person_future_dob</span>(<span class="params">text, dob, create_tables</span>):</span><br><span class="line">    <span class="keyword">with</span> pytest.raises(AssertionError):</span><br><span class="line">        pr.create(name=text, dob=dob)</span><br></pre></td></tr></table></figure>
<p>Similarly, we’ll add a test to ensure that dates cannot be more than 120 years in the past.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@given(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">    text=st.text(<span class="params">min_size=<span class="number">1</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    dob=st.dates(<span class="params">max_value=MIN_DATE - datetime.timedelta(<span class="params">days=<span class="number">365</span></span>)</span>),</span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_create_person_past_dob</span>(<span class="params">text, dob, create_tables</span>):</span><br><span class="line">    <span class="keyword">with</span> pytest.raises(AssertionError):</span><br><span class="line">        pr.create(name=text, dob=dob)</span><br></pre></td></tr></table></figure>
<p>Finally, we’ll add a test to ensure that in all other cases, the function creates a <code>Person</code> instance as expected.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@given(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">    text=st.text(<span class="params">min_size=<span class="number">5</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    dob=st.dates(<span class="params"></span></span></span></span><br><span class="line"><span class="params"><span class="params"><span class="meta">        min_value=MIN_DATE,</span></span></span></span><br><span class="line"><span class="params"><span class="params"><span class="meta">        max_value=MAX_DATE,</span></span></span></span><br><span class="line"><span class="params"><span class="params"><span class="meta">    </span>),</span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_create_person</span>(<span class="params">text, dob, create_tables</span>):</span><br><span class="line">    person = pr.create(name=text, dob=dob)</span><br><span class="line">    <span class="keyword">assert</span> <span class="number">0</span> &lt;= person.age &lt;= Person.MAX_AGE</span><br></pre></td></tr></table></figure>  
<p>The tests pass when we rerun them so we can be sure that the function behaves as expected.  </p>
<h3 id="Testing-a-REST-API"><a href="#Testing-a-REST-API" class="headerlink" title="Testing a REST API."></a>Testing a REST API.</h3><p>Finally, we’ll look at testing a REST API. We’ll create a small Flask app with an endpoint which allows us to create <code>Person</code> instances. The API endpoint is a simple wrapper around the <code>create</code> helper function and returns the created <code>Person</code> instance as a dictionary.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api.route(<span class="params"><span class="string">"/person"</span>, methods=[<span class="string">"POST"</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_person</span>():</span><br><span class="line">    name = request.json[<span class="string">"name"</span>]</span><br><span class="line"></span><br><span class="line">    dob = request.json[<span class="string">"dob"</span>]</span><br><span class="line">    dob = parse(dob).date()</span><br><span class="line"></span><br><span class="line">    person = pr.create(name, dob)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> model_to_dict(person)</span><br></pre></td></tr></table></figure>  
<p>We’ll add a test to generate random JSON dictionaries which we’ll pass as the body of the <code>POST</code> request. The test is given below.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@given(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">    json=st.fixed_dictionaries(<span class="params"></span></span></span></span><br><span class="line"><span class="params"><span class="params"><span class="meta">        {</span></span></span></span><br><span class="line"><span class="params"><span class="params"><span class="meta">            <span class="string">"name"</span>: st.text(<span class="params">min_size=<span class="number">5</span></span>),</span></span></span></span><br><span class="line"><span class="params"><span class="params"><span class="meta">            <span class="string">"dob"</span>: st.dates(<span class="params">min_value=MIN_DATE, max_value=MAX_DATE</span>),</span></span></span></span><br><span class="line"><span class="params"><span class="params"><span class="meta">        }</span></span></span></span><br><span class="line"><span class="params"><span class="params"><span class="meta">    </span>)</span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_create_person</span>(<span class="params">json, test_client</span>):</span><br><span class="line">    response = test_client.post(</span><br><span class="line">        <span class="string">"/api/person"</span>,</span><br><span class="line">        json=json,</span><br><span class="line">        headers={<span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>},</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> response.status_code == <span class="number">200</span></span><br></pre></td></tr></table></figure>  
<p>Similar to the tests for <code>create</code> function, we test that the API returns a response successfully when the inputs are proper.  </p>
<p>That’s it. That’s how we can leverage Hypothesis to test Python code. You’ll find the code for this post in <a target="_blank" rel="noopener" href="https://github.com/thescalaguy/pytesting">the Github repository.</a></p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://fasihkhatib.com/2024/11/24/Property-based-testing-with-Hypothesis/" data-id="cmguwlrcc002mjtru2p24dxxy" data-title="Property-based testing with Hypothesis" class="article-share-link">Share</a>
      
        <a href="http://fasihkhatib.com/2024/11/24/Property-based-testing-with-Hypothesis/#disqus_thread" class="article-comment-link">Comments</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/testing/" rel="tag">testing</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/12/04/Programming-Puzzles-5/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Programming Puzzles 5
        
      </div>
    </a>
  
  
    <a href="/2024/11/06/Programming-Puzzles-4/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Programming Puzzles 4</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/algorithms/" style="font-size: 10px;">algorithms</a> <a href="/tags/architecture/" style="font-size: 20px;">architecture</a> <a href="/tags/category-theory/" style="font-size: 12.5px;">category theory</a> <a href="/tags/clojure/" style="font-size: 10px;">clojure</a> <a href="/tags/compilers/" style="font-size: 12.5px;">compilers</a> <a href="/tags/epi/" style="font-size: 12.5px;">epi</a> <a href="/tags/functional-programming/" style="font-size: 18.75px;">functional programming</a> <a href="/tags/machine-learning/" style="font-size: 13.75px;">machine learning</a> <a href="/tags/math/" style="font-size: 11.25px;">math</a> <a href="/tags/misc/" style="font-size: 15px;">misc</a> <a href="/tags/python/" style="font-size: 12.5px;">python</a> <a href="/tags/scala/" style="font-size: 17.5px;">scala</a> <a href="/tags/scalaz/" style="font-size: 16.25px;">scalaz</a> <a href="/tags/testing/" style="font-size: 10px;">testing</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/10/17/Writing-a-PRD-Restaurant-Reservations/">Writing a PRD - Curated Menus at Restaurants</a>
          </li>
        
          <li>
            <a href="/2025/06/25/Real-time-restaurant-recommendations/">Real-time Restaurant Recommendations</a>
          </li>
        
          <li>
            <a href="/2025/01/12/Creating-a-realtime-data-platform-indexing/">Creating a realtime data platform - indexing</a>
          </li>
        
          <li>
            <a href="/2025/01/10/Creating-a-realtime-data-platform-embedding/">Creating a realtime data platform - embedding</a>
          </li>
        
          <li>
            <a href="/2025/01/06/Creating-a-realtime-data-platform-visualization/">Creating a realtime data platform - visualization</a>
          </li>
        
          <li>
            <a href="/2025/01/04/Creating-a-realtime-data-platform-orchestration/">Creating a realtime data platform - orchestration</a>
          </li>
        
          <li>
            <a href="/2025/01/02/Creating-a-realtime-data-platform-SQL/">Creating a realtime data platform - SQL</a>
          </li>
        
          <li>
            <a href="/2024/12/27/Creating-a-realtime-data-platform-nullability/">Creating a realtime data platform - nullability</a>
          </li>
        
          <li>
            <a href="/2024/12/26/Creating-a-realtime-data-platform-evolving-the-schema/">Creating a realtime data platform - evolving the schema</a>
          </li>
        
          <li>
            <a href="/2024/12/24/Creating-a-realtime-data-platform-bringing-data-in/">Creating a realtime data platform - bringing data in</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2025 Fasih Khatib<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About Me</a>
  
    <a href="/principles" class="mobile-nav-link">Guiding Principles</a>
  
</nav>
    
<script>
  var disqus_shortname = 'https-thescalaguy-github-io';
  
  var disqus_url = 'http://fasihkhatib.com/2024/11/24/Property-based-testing-with-Hypothesis/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>